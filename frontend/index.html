<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Diligence Cloud</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f7fa; display: flex; flex-direction: column; height: 100vh; overflow: hidden; width: 100%; margin: 0; padding: 0; }
        
        /* Header */
        .header {
            background: white;
            padding: 16px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .brand {
            display: flex;
            flex-direction: column;
        }
        
        .brand-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .brand-tagline {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .stat-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.688rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 2px;
        }
        
        /* Main Container with Sidebar */
        .main-container {
            display: none;
            flex: 1;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        .main-container.visible {
            display: flex;
        }
        
        /* Left Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-new-project {
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-new-project:hover {
            background: #5568d3;
        }
        
        .project-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        
        .project-item {
            padding: 8px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            position: relative;
        }
        
        .project-item:hover {
            background: #f9fafb;
        }
        
        .project-item.active {
            background: #eff6ff;
            border-left: 3px solid #667eea;
        }
        
        .project-icon {
            width: 18px;
            height: 18px;
            color: #9ca3af;
            flex-shrink: 0;
        }
        
        .project-name {
            font-size: 0.875rem;
            color: #374151;
            flex: 1;
            cursor: pointer;
        }
        
        .project-name:hover {
            background: #f9fafb;
            border-radius: 3px;
        }
        
        .project-name-input {
            width: 100%;
            padding: 2px 4px;
            border: 2px solid #667eea;
            border-radius: 3px;
            font-size: 0.875rem;
            font-family: inherit;
            color: #374151;
            background: white;
            outline: none;
        }
        
        .expand-icon {
            width: 14px;
            height: 14px;
            color: #9ca3af;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .add-subfolder-btn,
        .edit-project-btn,
        .delete-project-btn {
            opacity: 0.4;
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .add-subfolder-btn {
            font-size: 16px;
            font-weight: bold;
        }
        
        .edit-project-btn {
            margin-left: 4px;
        }
        
        .delete-project-btn {
            margin-left: 2px;
            color: #ef4444;
        }
        
        .project-item:hover .add-subfolder-btn,
        .project-item:hover .edit-project-btn,
        .project-item:hover .delete-project-btn {
            opacity: 1;
        }
        
        .add-subfolder-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .edit-project-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .delete-project-btn:hover {
            background: #ef4444;
            color: white;
        }
        
        .subfolder-item {
            padding: 8px 12px 8px 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: #4b5563;
            transition: background 0.2s;
        }
        
        .subfolder-item:hover {
            background: #f9fafb;
        }
        
        .subfolder-item.active {
            background: #eff6ff;
            color: #2563eb;
            border-left: 3px solid #2563eb;
        }
        
        .subfolder-icon {
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .sub-items {
            display: none;
            padding-left: 28px;
        }
        
        .sub-items.visible {
            display: block;
        }
        
        .sub-item {
            padding: 6px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            position: relative;
        }
        
        .sub-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #e5e7eb;
        }
        
        .sub-item:hover {
            background: #f9fafb;
        }
        
        .sub-icon {
            width: 16px;
            height: 16px;
            color: #9ca3af;
            flex-shrink: 0;
        }
        
        .sub-name {
            font-size: 0.813rem;
            color: #6b7280;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        .tabs {
            background: white;
            padding: 0 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 32px;
            flex-shrink: 0;
        }
        
        .tab {
            padding: 16px 4px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: #111827;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .content {
            display: none;
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
        }
        
        .content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Q&A Content - Full height table */
        #content-qa {
            padding: 0;
        }
        
        #content-qa table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        /* Upload Content - Regular padding */
        #content-upload {
            padding: 30px 40px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        /* Make table fill container initially, allow scroll when resized */
        #qaTable {
            min-width: 100%;
        }
        
        th {
            background: #f9f9f9;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            white-space: nowrap;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 24px;
            z-index: 10;
            user-select: none;
        }
        
        /* Column letter row styling */
        #columnLetterRow th {
            background: #f3f4f6;
            padding: 4px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 10px;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 11;
            min-width: 60px;
        }
        
        /* Row number column styling */
        .row-number-cell {
            background: #f3f4f6;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            color: #6b7280;
            border-right: 1px solid #e5e7eb;
            position: sticky;
            left: 0;
            z-index: 9;
            min-width: 50px;
            width: 50px;
            user-select: none;
            cursor: default;
        }
        
        .row-number-cell:hover {
            background: #e5e7eb;
        }
        
        .row-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
        }
        
        .row-number-cell:hover .row-delete-btn {
            opacity: 1;
        }
        
        .row-delete-btn:hover {
            background: #dc2626;
        }
        
        /* Freeze panes: First column (row numbers) stays fixed */
        #qaTable thead tr th:first-child,
        #qaTable tbody tr td:first-child {
            position: sticky;
            left: 0;
            z-index: 8;
        }
        
        #qaTable thead tr th:first-child {
            z-index: 12;
        }
        
        #qaTable tbody tr td:first-child {
            z-index: 7;
        }
        
        /* Ensure row number cell has proper background when row is hovered */
        tbody tr:hover td:first-child {
            background: #e5e7eb;
        }
        
        .column-resizer {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            background: transparent;
            z-index: 11;
        }
        
        .column-resizer:hover {
            background: #667eea;
        }
        
        .column-resizer.resizing {
            background: #667eea;
        }
        
        .btn-add-column {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 12px;
        }
        
        .btn-add-column:hover {
            background: #5568d3;
        }
        
        .column-menu {
            position: relative;
            display: inline-block;
        }
        
        .column-dropdown {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 8px;
            z-index: 1000;
            min-width: 200px;
            top: 100%;
            right: 0;
            margin-top: 4px;
        }
        
        .column-dropdown.show {
            display: block;
        }
        
        .column-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.813rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .column-option:hover {
            background: #f9fafb;
        }
        
        .column-option input[type="checkbox"] {
            cursor: pointer;
        }
        
        .add-custom-column {
            border-top: 1px solid #e5e7eb;
            margin-top: 8px;
            padding-top: 8px;
        }
        
        .add-custom-column input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.813rem;
            margin-bottom: 6px;
        }
        
        .add-custom-column button {
            width: 100%;
            padding: 6px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .custom-cell-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.813rem;
            font-family: inherit;
        }
        
        .custom-cell-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            background: white;
        }
        
        tbody tr:hover td {
            background: #fafbfc;
        }
        
        .answer-text {
            line-height: 1.7;
            color: #374151;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        
        .answer-editable {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 0.875rem;
            line-height: 1.7;
            resize: vertical;
            background: white;
        }
        
        .answer-editable:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .answer-display {
            position: relative;
        }
        
        .edit-answer-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .answer-display:hover .edit-answer-btn {
            opacity: 1;
        }
        
        .save-answer-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 4px;
        }
        
        .cancel-answer-btn {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 4px;
            margin-left: 4px;
        }
        
        .source-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .source-item {
            font-size: 0.813rem;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .source-link {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .source-link:hover {
            background: #eff6ff;
            text-decoration: underline;
        }
        
        .empty-text {
            color: #d1d5db;
            font-style: italic;
        }
        
        input.q {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        input.q:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .followup-input {
            margin-left: 30px;
            width: calc(100% - 30px) !important;
            border-left: 3px solid #667eea;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-ready { background: #fef3c7; color: #92400e; }
        .badge-processing { background: #dbeafe; color: #1e40af; }
        .badge-done { background: #d1fae5; color: #065f46; }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-followup {
            background: none;
            color: #667eea;
            padding: 4px 8px;
            font-size: 18px;
            opacity: 0;
        }
        
        tr:hover .btn-followup {
            opacity: 1;
        }
        
        .btn-toggle {
            background: #eff6ff;
            color: #667eea;
            padding: 3px 8px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .followup-row {
            background: #fafbfc;
        }
        
        .hidden {
            display: none !important;
        }
        
        .upload-box {
            border: 2px dashed #ddd;
            padding: 60px;
            text-align: center;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .upload-box:hover {
            border-color: #667eea;
            background: #fafbfc;
        }
        
        .doc-card {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .doc-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        
        .doc-name {
            font-size: 0.938rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .doc-meta {
            font-size: 0.813rem;
            color: #6b7280;
            line-height: 1.6;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            min-height: 80px;
            resize: vertical;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Landing Page Styles */
        .landing-page {
            display: none;
            padding: 40px;
            background: #f5f7fa;
            min-height: calc(100vh - 80px);
        }
        
        .landing-page.active {
            display: block;
        }
        
        .landing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }
        
        .landing-title {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }
        
        .landing-subtitle {
            color: #6b7280;
            margin-top: 8px;
            font-size: 1rem;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }
        
        .project-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .project-card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }
        
        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .project-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
            flex: 1;
        }
        
        .project-card-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .project-card:hover .project-card-actions {
            opacity: 1;
        }
        
        .project-card-action-btn {
            background: transparent;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .project-card-action-btn:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        .project-card-action-btn.delete:hover {
            background: #fee2e2;
            color: #dc2626;
            border-color: #dc2626;
        }
        
        
        .project-card-footer {
            border-top: 1px solid #f3f4f6;
            padding-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.813rem;
            color: #9ca3af;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #9ca3af;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-state-title {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .main-container.landing-active .sidebar {
            display: none;
        }
        
        .main-container.landing-active .content-area {
            width: 100%;
            max-width: none;
        }
        
        .back-button {
            background: white;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .back-button:hover {
            background: #f9fafb;
            color: #111827;
            border-color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">D</div>
            <div class="brand">
                <h1 class="brand-name">Diligence Cloud</h1>
                <p class="brand-tagline">AI-Powered Document Intelligence Platform</p>
            </div>
        </div>
        <div class="header-right">
            <!-- Global counts removed - each project shows its own counts -->
        </div>
    </div>
    
    <!-- Landing Page -->
    <div class="landing-page active" id="landingPage">
        <div class="landing-header">
            <div>
                <h1 class="landing-title">My Projects</h1>
                <p class="landing-subtitle">Manage your due diligence projects</p>
            </div>
            <button class="btn-primary" onclick="showNewProjectModal()">+ New Project</button>
        </div>
        
        <div class="projects-grid" id="projectsGrid">
            <!-- Projects will be loaded here -->
        </div>
    </div>
    
    <!-- Main Container with Sidebar -->
    <div class="main-container" id="projectView">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Projects</div>
                <button class="btn-new-project" onclick="showNewProjectModal()">+ New</button>
            </div>
            <div class="project-tree" id="projectTree">
                <!-- Projects will be loaded here -->
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <div style="padding: 16px; background: white; border-bottom: 1px solid #e5e7eb; width: 100%;">
                <button class="back-button" onclick="showLandingPage()">
                    ← Back to Projects
                </button>
            </div>
            <div class="tabs" style="width: 100%;">
                <div class="tab active" id="tab-qa">Q&A Interface</div>
                <div class="tab" id="tab-upload">Upload Documents</div>
            </div>
            
            <div class="content active" id="content-qa">
                <div style="padding: 20px 16px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div style="padding-left: 16px;">
                        <h2 style="font-size: 1.25rem; color: #111827; margin: 0;">Questions & Answers</h2>
                        <p style="color: #6b7280; font-size: 0.813rem; margin: 4px 0 0 0;">Click column names to edit • Drag edges to resize • Use ⚙️ menu to manage columns</p>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; padding-right: 16px;">
                        <div class="column-menu">
                            <button class="btn-add-column" onclick="toggleColumnMenu()">⚙️ Columns</button>
                            <div class="column-dropdown" id="columnDropdown">
                                <div style="font-weight: 600; font-size: 0.75rem; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;">Show/Hide Columns</div>
                                <div id="columnOptions"></div>
                                <div class="add-custom-column">
                                    <input type="text" id="customColumnName" placeholder="Custom column name..." onkeypress="if(event.key=='Enter') addCustomColumn()">
                                    <button onclick="addCustomColumn()">+ Add Custom Column</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="exportExcel()" 
                                onmouseover="this.style.background='#059669'" 
                                onmouseout="this.style.background='#10b981'"
                                style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.813rem; transition: all 0.2s;">
                            📊 Export
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto; overflow-y: auto; flex: 1; width: 100%; position: relative;" id="tableScrollContainer">
                    <table id="qaTable" style="width: 100%;">
                        <thead>
                            <tr id="columnLetterRow" style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                                <!-- Column letters will be inserted here -->
                            </tr>
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="content" id="content-upload">
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 1.5rem; color: #111827; margin-bottom: 6px;">Upload Documents</h2>
                    <p style="color: #6b7280; font-size: 0.875rem;">Upload PDF, Excel, Word, or Text files to analyze with AI</p>
                </div>
                <div class="upload-box" id="uploadBox">
                    <div style="font-size: 48px; margin-bottom: 15px;">📄</div>
                    <h3 style="color: #111827; margin-bottom: 8px;">Click to upload or drag & drop files</h3>
                    <p style="color: #9ca3af; font-size: 0.875rem;">Supports PDF, Excel (.xlsx, .csv), Word (.docx), and Text (.txt) files</p>
                    <input type="file" id="fileInput" multiple style="display: none;" accept=".pdf,.xlsx,.xls,.csv,.docx,.txt">
                </div>
                <h3 style="margin-top: 32px; font-size: 1.125rem; color: #111827;">Your Documents</h3>
                <div id="docList"></div>
            </div>
        </div>
    </div>
    
    <!-- New Project Modal -->
    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">Create New Project</div>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="projectName" placeholder="e.g., Acme Corp Due Diligence">
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea class="form-textarea" id="projectDescription" placeholder="Brief description of this project..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                <button class="btn-primary" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>
    
    <!-- Add Subfolder Modal -->
    <div class="modal" id="addSubfolderModal">
        <div class="modal-content">
            <div class="modal-header">Add Subfolder</div>
            <div class="form-group">
                <label class="form-label">Subfolder Name</label>
                <input type="text" class="form-input" id="subfolderName" placeholder="e.g., Financial Documents, Legal Files, etc.">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeAddSubfolderModal()">Cancel</button>
                <button class="btn-primary" onclick="createSubfolder()">Add Subfolder</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Project Modal -->
    <div class="modal" id="editProjectModal">
        <div class="modal-content">
            <div class="modal-header">Edit Project</div>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="editProjectName" placeholder="Project name">
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea class="form-textarea" id="editProjectDescription" placeholder="Brief description of this project..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
                <button class="btn-primary" onclick="updateProject()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        const API = 'http://localhost:8002';
        let qs = [];
        let currentProjectId = null;
        let currentSubfolderId = null;
        let editingProjectId = null;
        let inlineEditingProjectId = null;
        let projects = [];
        let subfolders = {}; // Store subfolders per project: { projectId: [subfolders] }
        let currentView = 'landing'; // 'landing' or 'project'
        
        // Helper function to convert number to Excel column letter (A, B, C... Z, AA, AB...)
        function numberToColumnLetter(n) {
            let result = '';
            while (n > 0) {
                n--;
                result = String.fromCharCode(65 + (n % 26)) + result;
                n = Math.floor(n / 26);
            }
            return result;
        }
        
        // Helper function to get column letter for a column ID
        function getColumnLetter(columnId) {
            const visibleColumns = columns.filter(col => col.visible && !col.isRowNumber);
            const index = visibleColumns.findIndex(col => col.id === columnId);
            return index >= 0 ? numberToColumnLetter(index + 1) : '';
        }
        
        // Column management
        let columns = [
            { id: 'question', name: 'Question', visible: true, width: 300, default: false },
            { id: 'answer', name: 'Answer', visible: true, width: 400, default: false },
            { id: 'source', name: 'Source', visible: true, width: 180, default: false },
            { id: 'status', name: 'Status', visible: true, width: 120, default: false },
            { id: 'date', name: 'Date', visible: true, width: 120, default: false }
        ];
        
        // Assign column letters to all columns
        function assignColumnLetters() {
            columns.forEach((col, index) => {
                if (!col.isRowNumber) {
                    col.letter = numberToColumnLetter(index + 1);
                }
            });
        }
        
        // Initialize column letters
        assignColumnLetters();
        
        // Function to renumber all rows after deletion
        function renumberRows() {
            const tbody = document.getElementById('tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach((row, index) => {
                const rowNumber = (index + 1).toString();
                row.dataset.rowNumber = rowNumber;
                const rowNumCell = row.cells[0]; // First cell is always row number
                if (rowNumCell && rowNumCell.classList.contains('row-number-cell')) {
                    const span = rowNumCell.querySelector('span');
                    if (span) {
                        span.textContent = rowNumber;
                    }
                    rowNumCell.dataset.rowNumber = rowNumber;
                    rowNumCell.title = `Row ${rowNumber}`;
                }
            });
            
            // Recalculate all formulas after renumbering
            recalculateAllFormulas();
        }
        
        // Helper function to parse cell reference (e.g., "A1" -> {column: 0, row: 1})
        function parseCellReference(ref) {
            const match = ref.match(/^([A-Z]+)(\d+)$/);
            if (!match) return null;
            
            const colLetters = match[1];
            const rowNum = parseInt(match[2]);
            
            // Convert column letters to index
            let colIndex = 0;
            for (let i = 0; i < colLetters.length; i++) {
                colIndex = colIndex * 26 + (colLetters.charCodeAt(i) - 64);
            }
            colIndex -= 1; // Convert from 1-based to 0-based
            
            return { columnIndex: colIndex, rowNumber: rowNum };
        }
        
        // Helper function to convert column index to letter
        function columnIndexToLetter(index) {
            return numberToColumnLetter(index + 1);
        }
        
        // Function to resolve cell reference to actual value
        function resolveCellReference(ref) {
            const parsed = parseCellReference(ref);
            if (!parsed) return null;
            
            const tbody = document.getElementById('tbody');
            if (!tbody) return null;
            
            // Find row by row number
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const targetRow = rows.find(row => {
                const rowNum = row.dataset.rowNumber;
                return rowNum && parseInt(rowNum) === parsed.rowNumber;
            });
            
            if (!targetRow) return null;
            
            // Get visible columns
            const visibleColumns = columns.filter(col => col.visible);
            if (parsed.columnIndex >= visibleColumns.length) return null;
            
            const targetColumn = visibleColumns[parsed.columnIndex];
            if (!targetColumn) return null;
            
            // Get cell by column ID
            const cell = getCellByColumnId(targetRow, targetColumn.id);
            if (!cell) return null;
            
            // Extract text value from cell
            if (targetColumn.id === 'answer') {
                const answerDisplay = cell.querySelector('.answer-display .answer-text');
                if (answerDisplay) {
                    return answerDisplay.textContent.trim();
                }
            } else if (targetColumn.id === 'question') {
                const questionInput = cell.querySelector('.q');
                if (questionInput) {
                    return questionInput.value.trim();
                }
            } else {
                // For other columns, get text content
                return cell.textContent.trim();
            }
            
            return null;
        }
        
        // Function to parse and evaluate formula
        function parseFormula(formula) {
            if (!formula || !formula.startsWith('=')) {
                return { isFormula: false, value: formula };
            }
            
            const formulaBody = formula.substring(1).trim();
            
            // Check for operations
            const hasAddition = formulaBody.includes('+');
            const hasSubtraction = formulaBody.includes('-');
            
            if (hasAddition || hasSubtraction) {
                // Parse operation
                const parts = formulaBody.split(/[+-]/);
                const operators = formulaBody.match(/[+-]/g) || [];
                
                let result = null;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i].trim();
                    const cellRef = parseCellReference(part);
                    let value;
                    
                    if (cellRef) {
                        value = resolveCellReference(part);
                        // Try to parse as number, otherwise use as string
                        if (value !== null) {
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                value = numValue;
                            } else {
                                value = value || '';
                            }
                        } else {
                            value = '';
                        }
                    } else {
                        // Try to parse as number literal
                        const numValue = parseFloat(part);
                        if (!isNaN(numValue)) {
                            value = numValue;
                        } else {
                            value = part || '';
                        }
                    }
                    
                    if (result === null) {
                        result = value;
                    } else {
                        const op = operators[i - 1];
                        if (op === '+') {
                            if (typeof result === 'number' && typeof value === 'number') {
                                result = result + value;
                            } else {
                                result = String(result) + String(value);
                            }
                        } else if (op === '-') {
                            if (typeof result === 'number' && typeof value === 'number') {
                                result = result - value;
                            } else {
                                result = String(result).replace(String(value), '');
                            }
                        }
                    }
                }
                
                return { isFormula: true, value: result !== null ? String(result) : '' };
            } else {
                // Simple cell reference (e.g., =A1)
                const cellRef = parseCellReference(formulaBody);
                if (cellRef) {
                    const value = resolveCellReference(formulaBody);
                    return { isFormula: true, value: value !== null ? value : '' };
                } else {
                    // Concatenation (default for formulas without operators)
                    return { isFormula: true, value: formulaBody };
                }
            }
        }
        
        // Function to recalculate all formulas
        function recalculateAllFormulas() {
            const tbody = document.getElementById('tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach(row => {
                const answerCell = getCellByColumnId(row, 'answer');
                if (answerCell) {
                    const answerDisplay = answerCell.querySelector('.answer-display');
                    if (answerDisplay) {
                        const answerText = answerDisplay.querySelector('.answer-text');
                        if (answerText) {
                            const currentText = answerText.textContent;
                            // Check if it's a formula by checking if it was stored as formula
                            const rowId = row.dataset.id;
                            const q = qs.find(q => q.id == rowId);
                            if (q && q.formula) {
                                const result = parseFormula(q.formula);
                                if (result.isFormula) {
                                    answerText.textContent = result.value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Column resizing
        let isResizing = false;
        let currentColumn = null;
        let startX = 0;
        let startWidth = 0;
        let userHasResizedColumns = false;
        
        // Initialize column management
        function initializeColumns() {
            renderTableHeader();
            renderColumnOptions();
        }
        
        function renderTableHeader() {
            // Render column letter row
            const columnLetterRow = document.getElementById('columnLetterRow');
            if (columnLetterRow) {
                columnLetterRow.innerHTML = '';
                // Add empty cell for row number column
                const rowNumTh = document.createElement('th');
                rowNumTh.className = 'row-number-cell';
                rowNumTh.style.position = 'sticky';
                rowNumTh.style.left = '0';
                rowNumTh.style.zIndex = '13';
                columnLetterRow.appendChild(rowNumTh);
                
                // Add column letters
                columns.filter(col => col.visible).forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col.letter || '';
                    th.title = `Column ${col.letter}`;
                    columnLetterRow.appendChild(th);
                });
            }
            
            // Render header row
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';
            
            // Add row number column header
            const rowNumHeader = document.createElement('th');
            rowNumHeader.className = 'row-number-cell';
            rowNumHeader.textContent = '#';
            rowNumHeader.title = 'Row Number';
            header.appendChild(rowNumHeader);
            
            columns.filter(col => col.visible).forEach(col => {
                const th = document.createElement('th');
                th.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <input type="text" 
                               class="column-name-input" 
                               value="${col.name}" 
                               data-column="${col.id}"
                               onchange="renameColumn('${col.id}', this.value)"
                               onclick="event.stopPropagation()"
                               style="flex: 1; background: transparent; border: 1px solid transparent; padding: 2px 4px; border-radius: 3px; font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase;">
                    </div>
                    <div class="column-resizer" data-column="${col.id}"></div>
                `;
                header.appendChild(th);
            });
            
            // Add resize listeners
            document.querySelectorAll('.column-resizer').forEach(resizer => {
                resizer.addEventListener('mousedown', startResize);
            });
            
            // Add hover effect for column name inputs
            document.querySelectorAll('.column-name-input').forEach(input => {
                input.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#d1d5db';
                    this.style.background = 'white';
                });
                input.addEventListener('mouseleave', function() {
                    if (document.activeElement !== this) {
                        this.style.borderColor = 'transparent';
                        this.style.background = 'transparent';
                    }
                });
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#667eea';
                    this.style.background = 'white';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = 'transparent';
                    this.style.background = 'transparent';
                });
            });
            
            // Update table width after rendering header
            updateTableWidth();
        }
        
        function renderColumnOptions() {
            const container = document.getElementById('columnOptions');
            container.innerHTML = '';
            
            columns.forEach(col => {
                const option = document.createElement('div');
                option.className = 'column-option';
                const isRequired = col.id === 'question' || col.id === 'answer';
                option.innerHTML = `
                    <input type="checkbox" 
                           id="col-${col.id}" 
                           ${col.visible ? 'checked' : ''} 
                           onchange="toggleColumn('${col.id}')">
                    <label for="col-${col.id}" style="cursor: pointer; flex: 1;">
                        ${col.name} ${col.letter ? `(${col.letter})` : ''}
                    </label>
                    ${!isRequired ? `<button onclick="event.stopPropagation(); deleteColumn('${col.id}')" style="background: #ef4444; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 10px; cursor: pointer;" title="Delete column">×</button>` : ''}
                `;
                container.appendChild(option);
            });
        }
        
        function renameColumn(columnId, newName) {
            const col = columns.find(c => c.id === columnId);
            if (col && newName.trim()) {
                col.name = newName.trim();
                renderColumnOptions();
            }
        }
        
        function toggleColumnMenu() {
            const dropdown = document.getElementById('columnDropdown');
            dropdown.classList.toggle('show');
        }
        
        function toggleColumn(columnId) {
            const col = columns.find(c => c.id === columnId);
            if (col) {
                col.visible = !col.visible;
                renderTableHeader();
                renderTable();
            }
        }
        
        function addCustomColumn() {
            const input = document.getElementById('customColumnName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a column name');
                return;
            }
            
            const id = 'custom_' + Date.now();
            columns.push({
                id: id,
                name: name,
                visible: true,
                width: 150,
                default: false
            });
            
            input.value = '';
            renderTableHeader();
            renderColumnOptions();
            renderTable();
        }
        
        function removeColumn(columnId) {
            if (confirm('Remove this column?')) {
                columns = columns.filter(c => c.id !== columnId);
                renderTableHeader();
                renderColumnOptions();
                renderTable();
            }
        }
        
        // Column resizing
        function startResize(e) {
            e.preventDefault();
            isResizing = true;
            currentColumn = e.target.dataset.column;
            startX = e.pageX;
            
            const col = columns.find(c => c.id === currentColumn);
            startWidth = col.width;
            
            e.target.classList.add('resizing');
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        function doResize(e) {
            if (!isResizing) return;
            
            const diff = e.pageX - startX;
            const col = columns.find(c => c.id === currentColumn);
            const newWidth = Math.max(80, startWidth + diff);
            
            col.width = newWidth;
            userHasResizedColumns = true;
            updateTableWidth();
        }
        
        function updateTableWidth() {
            const totalWidth = columns
                .filter(col => col.visible)
                .reduce((sum, col) => sum + col.width, 0);
            
            const table = document.getElementById('qaTable');
            const visibleColumns = columns.filter(col => col.visible);
            
            if (!userHasResizedColumns) {
                // Mode 1: Percentage-based to fill full width
                const header = document.getElementById('tableHeader');
                if (header && totalWidth > 0) {
                    const ths = header.querySelectorAll('th');
                    ths.forEach((th, index) => {
                        if (visibleColumns[index]) {
                            const percentage = (visibleColumns[index].width / totalWidth) * 100;
                            th.style.width = percentage + '%';
                            th.style.minWidth = '0';
                        }
                    });
                }
                
                const tbody = document.getElementById('tbody');
                if (tbody && totalWidth > 0) {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (visibleColumns[index]) {
                                const percentage = (visibleColumns[index].width / totalWidth) * 100;
                                cell.style.width = percentage + '%';
                                cell.style.minWidth = '0';
                            }
                        });
                    });
                }
                
                if (table) {
                    table.style.width = '100%';
                    table.style.minWidth = '100%';
                }
            } else {
                // Mode 2: Fixed pixels, allow overflow
                const header = document.getElementById('tableHeader');
                if (header) {
                    const ths = header.querySelectorAll('th');
                    ths.forEach((th, index) => {
                        if (visibleColumns[index]) {
                            th.style.width = visibleColumns[index].width + 'px';
                            th.style.minWidth = visibleColumns[index].width + 'px';
                            th.style.maxWidth = visibleColumns[index].width + 'px';
                        }
                    });
                }
                
                const tbody = document.getElementById('tbody');
                if (tbody) {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (visibleColumns[index]) {
                                cell.style.width = visibleColumns[index].width + 'px';
                                cell.style.minWidth = visibleColumns[index].width + 'px';
                                cell.style.maxWidth = visibleColumns[index].width + 'px';
                            }
                        });
                    });
                }
                
                if (table) {
                    table.style.width = totalWidth + 'px';
                    table.style.minWidth = totalWidth + 'px';
                }
            }
        }
        
        function stopResize(e) {
            if (!isResizing) return;
            
            isResizing = false;
            document.querySelectorAll('.column-resizer').forEach(r => r.classList.remove('resizing'));
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.querySelector('.column-menu');
            const dropdown = document.getElementById('columnDropdown');
            if (menu && !menu.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Helper function to get cell for a specific column ID in a row
        function getCellByColumnId(row, columnId) {
            const visibleColumns = columns.filter(col => col.visible);
            const columnIndex = visibleColumns.findIndex(col => col.id === columnId);
            if (columnIndex < 0) {
                console.warn(`[getCellByColumnId] Column ${columnId} not found in visible columns. Visible:`, visibleColumns.map(c => c.id));
                return null;
            }
            // +1 because row number column is first
            const cellIndex = columnIndex + 1;
            if (!row.cells || !row.cells[cellIndex]) {
                console.warn(`[getCellByColumnId] Row has ${row.cells ? row.cells.length : 0} cells, but need index ${cellIndex} for column ${columnId}`);
                return null;
            }
            return row.cells[cellIndex];
        }
        
        // Render table with current columns
        function renderTable() {
            const tbody = document.getElementById('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.forEach((row, rowIndex) => {
                const id = row.dataset.id;
                const isFollowup = row.classList.contains('followup-row');
                const parentId = row.dataset.parent;
                const prefix = isFollowup ? '└─ ' : '';
                
                // Get or assign row number
                let rowNumber = row.dataset.rowNumber;
                if (!rowNumber) {
                    rowNumber = (rowIndex + 1).toString();
                    row.dataset.rowNumber = rowNumber;
                }
                
                        // Get existing data
                        const questionInput = row.querySelector('.q');
                        // Get question from stored data if input is empty (handles orphaned answers)
                        let questionValue = questionInput ? questionInput.value : '';
                        if (!questionValue || questionValue.trim() === '') {
                            const storedQ = qs.find(q => q.id == id);
                            questionValue = storedQ ? (storedQ.question || '') : '';
                        }
                const answerDisplay = row.querySelector('.answer-display');
                const answerHTML = answerDisplay ? answerDisplay.innerHTML : '<span class="empty-text">—</span>';
                const sourceCell = getCellByColumnId(row, 'source');
                const sourceHTML = sourceCell ? sourceCell.innerHTML : '<span class="empty-text">—</span>';
                const statusCell = getCellByColumnId(row, 'status');
                const statusHTML = statusCell ? statusCell.innerHTML : '<span class="badge badge-ready">Ready</span>';
                const dateCell = getCellByColumnId(row, 'date');
                const dateHTML = dateCell ? dateCell.innerHTML : new Date().toLocaleDateString();
                
                // Store custom column data
                const customData = {};
                const visibleColumns = columns.filter(col => col.visible);
                visibleColumns.forEach((col, idx) => {
                    // Skip first cell (row number) when accessing existing cells
                    const cellIndex = idx + 1; // +1 because row number is first
                    if (!col.default && row.cells[cellIndex]) {
                        customData[col.id] = row.cells[cellIndex].innerHTML;
                    }
                });
                
                // Rebuild row with visible columns
                row.innerHTML = '';
                
                // Add row number cell first
                const rowNumTd = document.createElement('td');
                rowNumTd.className = 'row-number-cell';
                rowNumTd.innerHTML = `
                    <span>${rowNumber}</span>
                    <button class="row-delete-btn" onclick="event.stopPropagation(); deleteRow(${id})" title="Delete row">×</button>
                `;
                rowNumTd.dataset.rowNumber = rowNumber;
                rowNumTd.title = `Row ${rowNumber}`;
                row.appendChild(rowNumTd);
                
                // Add data cells
                columns.filter(col => col.visible).forEach(col => {
                    const td = document.createElement('td');
                    
                        if (col.id === 'question') {
                        // Escape quotes in questionValue to prevent XSS and syntax errors
                        const safeQuestionValue = (questionValue || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        // Use data attribute for ID to handle IDs with special characters
                        td.innerHTML = `
                            <input class="q ${isFollowup ? 'followup-input' : ''}" id="q${id}" 
                                   data-row-id="${id}"
                                   value="${safeQuestionValue}"
                                   placeholder="${prefix}Type and press Enter"
                                   onkeypress="if(event.key=='Enter' || event.keyCode===13) { const rowId = this.getAttribute('data-row-id') || this.id.replace('q',''); ask(rowId); }">
                            <button class="btn-followup" onclick="addQ('${id}')">↪</button>
                            <span id="thread${id}"></span>
                        `;
                    } else if (col.id === 'answer') {
                        td.innerHTML = `
                            <div class="answer-display" id="answerDisplay${id}">
                                ${answerHTML}
                            </div>
                            <div class="answer-edit" id="answerEdit${id}" style="display: none;">
                                <textarea class="answer-editable" id="answerText${id}" placeholder="Enter manual answer..."></textarea>
                                <div>
                                    <button class="save-answer-btn" onclick="saveAnswer(${id})">Save</button>
                                    <button class="cancel-answer-btn" onclick="cancelEditAnswer(${id})">Cancel</button>
                                </div>
                            </div>
                        `;
                    } else if (col.id === 'source') {
                        td.innerHTML = sourceHTML;
                    } else if (col.id === 'status') {
                        td.innerHTML = statusHTML;
                    } else if (col.id === 'date') {
                        td.style.fontSize = '0.813rem';
                        td.style.color = '#6b7280';
                        td.innerHTML = dateHTML;
                    } else {
                        // Custom column
                        td.innerHTML = customData[col.id] || '<input type="text" class="custom-cell-input" placeholder="—" style="width: 100%; border: 1px solid #e5e7eb; padding: 4px 8px; border-radius: 4px; font-size: 0.813rem;">';
                    }
                    
                    row.appendChild(td);
                });
            });
        }
        
        // Tabs
        document.getElementById('tab-qa').onclick = () => showTab('qa');
        document.getElementById('tab-upload').onclick = () => showTab('upload');
        
        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            document.getElementById('content-' + name).classList.add('active');
            if (name === 'upload') loadDocs();
        }
        
        // Project Management
        // View Management
        function showLandingPage() {
            currentView = 'landing';
            const landingPage = document.getElementById('landingPage');
            const projectView = document.getElementById('projectView');
            const header = document.getElementById('header');
            
            if (landingPage) landingPage.classList.add('active');
            if (projectView) projectView.classList.remove('landing-active', 'visible');
            if (header) header.style.display = 'flex';
            renderLandingPage();
        }
        
        function showProjectView(projectId) {
            currentView = 'project';
            const landingPage = document.getElementById('landingPage');
            const projectView = document.getElementById('projectView');
            const header = document.getElementById('header');
            
            if (landingPage) landingPage.classList.remove('active');
            if (projectView) projectView.classList.add('landing-active', 'visible');
            if (header) header.style.display = 'flex';
        }
        
        function renderLandingPage() {
            const grid = document.getElementById('projectsGrid');
            
            if (projects.length > 0) {
                grid.innerHTML = projects.map(p => {
                    const updatedAt = p.updated_at ? new Date(p.updated_at).toLocaleDateString() : 'Never';
                    
                    return `
                        <div class="project-card" id="project-${p.id}" onclick="openProject('${p.id}')">
                            <div class="project-card-header">
                                <h3 class="project-card-title"><span class="project-name">${p.name}</span></h3>
                                <div class="project-card-actions">
                                    <button class="project-card-action-btn" onclick="event.stopPropagation(); enableInlineEdit('${p.id}', '${p.name.replace(/'/g, "\\'")}')" title="Edit">✏️</button>
                                    <button class="project-card-action-btn delete" onclick="event.stopPropagation(); deleteProject('${p.id}', '${p.name.replace(/'/g, "\\'")}')" title="Delete">🗑️</button>
                                </div>
                            </div>
                            ${p.description ? `<p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 16px;">${p.description}</p>` : ''}
                            <div class="project-card-footer">
                                <span>Updated ${updatedAt}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">📁</div>
                        <div class="empty-state-title">No projects yet</div>
                        <p>Create your first project to get started with due diligence</p>
                    </div>
                `;
            }
        }
        
        async function loadProjects() {
            try {
                const r = await fetch(`${API}/api/projects`);
                const data = await r.json();
                projects = data.projects || [];
                
                const tree = document.getElementById('projectTree');
                
                // Render landing page if in landing view
                if (currentView === 'landing') {
                    renderLandingPage();
                }
                
                if (projects.length > 0) {
                    tree.innerHTML = projects.map(p => {
                        const isActive = p.id === currentProjectId ? 'active' : '';
                        return `
                            <div class="project-item ${isActive}" id="project-${p.id}">
                                <span class="expand-icon" onclick="event.stopPropagation(); toggleProject('${p.id}')">▶</span>
                                <span class="project-icon" onclick="selectProject('${p.id}')">📁</span>
                                <span class="project-name" onclick="selectProject('${p.id}')">${p.name}</span>
                                <button class="edit-project-btn" onclick="event.stopPropagation(); enableInlineEdit('${p.id}', '${p.name.replace(/'/g, "\\'")}')" title="Edit project">✏️</button>
                                <button class="delete-project-btn" onclick="event.stopPropagation(); deleteProject('${p.id}', '${p.name.replace(/'/g, "\\'")}')" title="Delete project">🗑️</button>
                                <button class="add-subfolder-btn" onclick="event.stopPropagation(); showAddSubfolderModal('${p.id}')" title="Add subfolder">+</button>
                            </div>
                            <div class="sub-items" id="sub-${p.id}">
                                <!-- Sub-items will be loaded here -->
                            </div>
                        `;
                    }).join('');
                    
                    // Set current project to first one if not set AND we're in project view
                    // But don't auto-select on landing page - let user explicitly choose
                    if (!currentProjectId && projects.length > 0 && currentView === 'project') {
                        currentProjectId = projects[0].id;
                        selectProject(currentProjectId);
                    }
                    
                    // Only load documents as sub-items for active project if we're in project view
                    // Don't load documents when on landing page to avoid showing duplicates
                    if (currentProjectId && currentView === 'project') {
                        loadProjectDocuments(currentProjectId);
                    }
                } else {
                    tree.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 0.875rem;">No projects yet.<br>Click "+ New" to create one.</div>';
                }
            } catch (e) {
                console.error('Failed to load projects:', e);
            }
        }
        
        async function loadProjectDocuments(projectId) {
            try {
                console.log(`[loadProjectDocuments] Loading documents for project: ${projectId}`);
                const r = await fetch(`${API}/api/documents?project_id=${projectId}`);
                const data = await r.json();
                const documents = data.documents || [];
                console.log(`[loadProjectDocuments] Received ${documents.length} documents for project ${projectId}:`, documents.map(d => d.filename));
                
                const subContainer = document.getElementById(`sub-${projectId}`);
                if (subContainer) {
                    if (documents.length > 0) {
                        subContainer.innerHTML = documents.map(doc => `
                            <div class="sub-item">
                                <span class="sub-icon">📄</span>
                                <span class="sub-name">${doc.filename}</span>
                            </div>
                        `).join('');
                        subContainer.classList.add('visible');
                    } else {
                        subContainer.innerHTML = '';
                        subContainer.classList.remove('visible');
                    }
                }
            } catch (e) {
                console.error('Failed to load documents:', e);
            }
        }
        
        function selectProject(projectId, clearSubfolder = true) {
            currentProjectId = projectId;
            console.log('selectProject called - projectId:', projectId, 'currentProjectId set to:', currentProjectId);
            if (clearSubfolder) {
                currentSubfolderId = null;
            }
            
            // If we're on landing page, switch to project view
            if (currentView === 'landing') {
                showProjectView(projectId);
            }
            
            // Update active state
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });
            const selected = document.getElementById(`project-${projectId}`);
            if (selected) {
                selected.classList.add('active');
            }
            
            // Reload documents and questions for new project
            loadProjectDocuments(projectId);
            loadDocs();
            updateProjectStats();
            
            // Load Q&A history for the selected project (this will also add a question input row)
            loadQAHistory();
            
            // Ensure a question row exists even if loadQAHistory returns early
            // Check if tbody has any input rows, if not, add one
            setTimeout(() => {
                const tbody = document.getElementById('tbody');
                if (tbody) {
                    const hasInputRow = Array.from(tbody.querySelectorAll('tr')).some(row => {
                        const input = row.querySelector('input.q');
                        return input && !input.readOnly;
                    });
                    if (!hasInputRow) {
                        addQ();
                    }
                }
            }, 100);
        }
        
        function openProject(projectId) {
            // Set currentProjectId immediately to ensure it's available for uploads
            currentProjectId = projectId;
            console.log('openProject called - projectId:', projectId, 'currentProjectId set to:', currentProjectId);
            showProjectView(projectId);
            selectProject(projectId);
        }
        
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('show');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
        }
        
        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('show');
        }
        
        async function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            
            if (!name) {
                alert('Please enter a project name');
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/projects`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description })
                });
                
                if (r.ok) {
                    const data = await r.json();
                    alert('✓ Project created: ' + name);
                    closeNewProjectModal();
                    
                    // Reload projects and return to landing page
                    await loadProjects();
                    showLandingPage();
                } else {
                    alert('Failed to create project');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProjectStats() {
            // Global header counts removed - each project shows its own counts
            // This function is kept for compatibility but does nothing
        }
        
        // Edit Project
        async function showEditProjectModal(projectId, projectName) {
            editingProjectId = projectId;
            
            try {
                // Fetch full project details
                const r = await fetch(`${API}/api/projects/${projectId}`);
                const data = await r.json();
                
                if (data.project) {
                    document.getElementById('editProjectName').value = data.project.name || '';
                    document.getElementById('editProjectDescription').value = data.project.description || '';
                    document.getElementById('editProjectModal').classList.add('show');
                    document.getElementById('editProjectName').focus();
                }
            } catch (e) {
                console.error('Failed to load project details:', e);
                // Fallback to just the name
                document.getElementById('editProjectName').value = projectName;
                document.getElementById('editProjectDescription').value = '';
                document.getElementById('editProjectModal').classList.add('show');
                document.getElementById('editProjectName').focus();
            }
        }
        
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.remove('show');
            editingProjectId = null;
        }
        
        async function updateProject() {
            const name = document.getElementById('editProjectName').value.trim();
            const description = document.getElementById('editProjectDescription').value.trim();
            
            if (!name) {
                alert('Please enter a project name');
                return;
            }
            
            if (!editingProjectId) {
                alert('No project selected for editing');
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/projects/${editingProjectId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description })
                });
                
                if (r.ok) {
                    alert('✓ Project updated: ' + name);
                    closeEditProjectModal();
                    
                    // Reload projects to show updated name
                    await loadProjects();
                    
                    // If this was the current project, keep it selected
                    if (currentProjectId === editingProjectId) {
                        selectProject(editingProjectId);
                    }
                } else {
                    alert('Failed to update project');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteProject(projectId, projectName) {
            if (!confirm(`Are you sure you want to delete "${projectName}"?\n\nThis will permanently delete the project and all its documents and Q&A history.`)) {
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/projects/${projectId}`, {
                    method: 'DELETE'
                });
                
                if (r.ok) {
                    alert('✓ Project deleted: ' + projectName);
                    
                    // Reload projects and return to landing page
                    await loadProjects();
                    showLandingPage();
                } else {
                    const errorData = await r.json();
                    alert('Failed to delete project: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // Inline editing functions
        function enableInlineEdit(projectId, projectName) {
            if (inlineEditingProjectId) {
                cancelInlineEdit();
            }
            
            inlineEditingProjectId = projectId;
            const nameSpan = document.querySelector(`#project-${projectId} .project-name`);
            
            if (nameSpan) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'project-name-input';
                input.value = projectName;
                input.id = `inline-edit-${projectId}`;
                
                // Replace the span with input
                nameSpan.innerHTML = '';
                nameSpan.appendChild(input);
                
                // Focus and select all text
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 10);
                
                // Handle save on Enter key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        saveInlineEdit(projectId);
                    } else if (e.key === 'Escape') {
                        cancelInlineEdit();
                    }
                });
                
                // Handle save on blur (clicking outside)
                input.addEventListener('blur', function(e) {
                    // Delay to allow click on save button
                    setTimeout(() => {
                        if (inlineEditingProjectId === projectId) {
                            saveInlineEdit(projectId);
                        }
                    }, 200);
                });
            }
        }
        
        async function saveInlineEdit(projectId) {
            const input = document.getElementById(`inline-edit-${projectId}`);
            if (!input) return;
            
            const newName = input.value.trim();
            
            if (!newName) {
                alert('Project name cannot be empty');
                return;
            }
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Don't update if name hasn't changed
            if (newName === project.name) {
                cancelInlineEdit();
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                });
                
                if (r.ok) {
                    // Reload projects to show updated name
                    await loadProjects();
                    
                    // If this was the current project, keep it selected
                    if (currentProjectId === projectId) {
                        selectProject(projectId);
                    }
                } else {
                    alert('Failed to update project name');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            
            inlineEditingProjectId = null;
        }
        
        function cancelInlineEdit() {
            if (!inlineEditingProjectId) return;
            
            inlineEditingProjectId = null;
            
            // Reload projects to restore original name
            loadProjects();
        }
        
        // Subfolder Management
        function showAddSubfolderModal(projectId) {
            currentProjectId = projectId;
            document.getElementById('addSubfolderModal').classList.add('show');
            document.getElementById('subfolderName').value = '';
            document.getElementById('subfolderName').focus();
        }
        
        function closeAddSubfolderModal() {
            document.getElementById('addSubfolderModal').classList.remove('show');
        }
        
        function createSubfolder() {
            const name = document.getElementById('subfolderName').value.trim();
            
            if (!name) {
                alert('Please enter a subfolder name');
                return;
            }
            
            if (!currentProjectId) {
                alert('No project selected');
                return;
            }
            
            // Initialize subfolders array for this project if it doesn't exist
            if (!subfolders[currentProjectId]) {
                subfolders[currentProjectId] = [];
            }
            
            // Create subfolder object
            const subfolder = {
                id: 'subfolder_' + Date.now(),
                name: name,
                projectId: currentProjectId
            };
            
            // Add to subfolders
            subfolders[currentProjectId].push(subfolder);
            
            // Save to localStorage
            localStorage.setItem('subfolders', JSON.stringify(subfolders));
            
            // Refresh the project tree
            renderProjectSubfolders(currentProjectId);
            
            // Close modal
            closeAddSubfolderModal();
            
            alert('✓ Subfolder created: ' + name);
        }
        
        function toggleProject(projectId) {
            const expandIcon = document.querySelector(`#project-${projectId} .expand-icon`);
            const subItems = document.getElementById(`sub-${projectId}`);
            
            if (subItems.classList.contains('visible')) {
                subItems.classList.remove('visible');
                expandIcon.classList.remove('expanded');
            } else {
                subItems.classList.add('visible');
                expandIcon.classList.add('expanded');
                renderProjectSubfolders(projectId);
            }
        }
        
        function renderProjectSubfolders(projectId) {
            const subItemsContainer = document.getElementById(`sub-${projectId}`);
            if (!subItemsContainer) return;
            
            // Load subfolders from localStorage
            const storedSubfolders = localStorage.getItem('subfolders');
            if (storedSubfolders) {
                subfolders = JSON.parse(storedSubfolders);
            }
            
            const projectSubfolders = subfolders[projectId] || [];
            
            if (projectSubfolders.length > 0) {
                subItemsContainer.innerHTML = projectSubfolders.map(sf => {
                    const isActive = sf.id === currentSubfolderId ? 'active' : '';
                    return `
                        <div class="subfolder-item ${isActive}" onclick="selectSubfolder('${sf.id}', '${projectId}')">
                            <span class="subfolder-icon">📂</span>
                            <span>${sf.name}</span>
                        </div>
                    `;
                }).join('');
            } else {
                subItemsContainer.innerHTML = '<div style="padding: 8px 12px 8px 40px; color: #9ca3af; font-size: 0.813rem;">No subfolders yet</div>';
            }
        }
        
        function selectSubfolder(subfolderId, projectId) {
            currentSubfolderId = subfolderId;
            currentProjectId = projectId;
            
            // Update active states
            document.querySelectorAll('.subfolder-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.subfolder-item').classList.add('active');
            
            // Update project active state
            selectProject(projectId, false);
        }
        
        // Questions
        function addQ(parentId) {
            const tbody = document.getElementById('tbody');
            if (!tbody) {
                console.error('[addQ] tbody element not found!');
                return;
            }
            // Generate unique ID: timestamp + random component to avoid collisions
            // Use hyphen instead of underscore to avoid issues in onclick handlers
            const id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const isFollowup = parentId != null;
            
            let row;
            if (isFollowup) {
                let after = document.querySelector(`[data-id="${parentId}"]`);
                let next = after ? after.nextElementSibling : null;
                while (next && next.dataset.parent == parentId) {
                    after = next;
                    next = next.nextElementSibling;
                }
                row = tbody.insertRow(after ? after.rowIndex : -1);
                row.className = 'followup-row';
                row.dataset.parent = parentId;
            } else {
                row = tbody.insertRow(-1);
            }
            
            row.dataset.id = id;
            const prefix = isFollowup ? '└─ ' : '';
            
            // Calculate row number based on position in tbody
            const existingRows = tbody.querySelectorAll('tr');
            const rowNumber = (existingRows.length).toString();
            row.dataset.rowNumber = rowNumber;
            
                // Add row number cell first
                const rowNumTd = document.createElement('td');
                rowNumTd.className = 'row-number-cell';
                rowNumTd.innerHTML = `
                    <span>${rowNumber}</span>
                    <button class="row-delete-btn" onclick="event.stopPropagation(); deleteRow(${id})" title="Delete row">×</button>
                `;
                rowNumTd.dataset.rowNumber = rowNumber;
                rowNumTd.title = `Row ${rowNumber}`;
                row.appendChild(rowNumTd);
            
            // Build row with visible columns
            columns.filter(col => col.visible).forEach(col => {
                const td = document.createElement('td');
                
                if (col.id === 'question') {
                    td.innerHTML = `
                        <input class="q ${isFollowup ? 'followup-input' : ''}" id="q${id}" 
                               placeholder="${prefix}Type and press Enter"
                               data-row-id="${id}"
                               onkeypress="if(event.key=='Enter' || event.keyCode===13) { const rowId = this.getAttribute('data-row-id') || this.id.replace('q',''); ask(rowId); }">
                        <button class="btn-followup" onclick="addQ('${id}')">↪</button>
                        <span id="thread${id}"></span>
                    `;
                } else if (col.id === 'answer') {
                    td.innerHTML = `
                        <div class="answer-display" id="answerDisplay${id}">
                            <span class="empty-text">—</span>
                            <button class="edit-answer-btn" onclick="editAnswer(${id})" title="Edit answer manually">✏️</button>
                        </div>
                        <div class="answer-edit" id="answerEdit${id}" style="display: none;">
                            <textarea class="answer-editable" id="answerText${id}" placeholder="Enter manual answer..."></textarea>
                            <div>
                                <button class="save-answer-btn" onclick="saveAnswer(${id})">Save</button>
                                <button class="cancel-answer-btn" onclick="cancelEditAnswer(${id})">Cancel</button>
                            </div>
                        </div>
                    `;
                } else if (col.id === 'source') {
                    td.innerHTML = '<span class="empty-text">—</span>';
                } else if (col.id === 'status') {
                    td.innerHTML = '<span class="badge badge-ready">Ready</span>';
                } else if (col.id === 'date') {
                    td.style.fontSize = '0.813rem';
                    td.style.color = '#6b7280';
                    td.innerHTML = new Date().toLocaleDateString();
                } else {
                    // Custom column
                    td.innerHTML = '<input type="text" class="custom-cell-input" placeholder="—" style="width: 100%; border: 1px solid #e5e7eb; padding: 4px 8px; border-radius: 4px; font-size: 0.813rem;">';
                }
                
                row.appendChild(td);
            });
            
            qs.push({id, parentId, followups: []});
            document.getElementById('q' + id).focus();
            updateStats();
            return id;
        }
        
        async function ask(id) {
            // Handle both numeric and string IDs (e.g., "1234567890-abc123def")
            const idStr = String(id);
            console.log(`[ask] Starting ask function for id ${idStr}`);
            const input = document.getElementById('q' + idStr);
            if (!input) {
                console.error(`[ask] Could not find input element for id ${idStr}`);
                return;
            }
            const question = input.value.trim();
            if (!question) {
                console.log(`[ask] Question is empty for id ${idStr}`);
                return;
            }
            
            if (!currentProjectId) {
                alert('Please select a project first');
                console.error(`[ask] No currentProjectId set`);
                return;
            }
            
            // Find and store row reference immediately to prevent race conditions
            // Handle both quoted and unquoted IDs in selector
            let row = document.querySelector(`[data-id="${idStr}"]`) || document.querySelector(`[data-id='${idStr}']`);
            if (!row) {
                console.error(`[ask] Could not find row for id ${idStr}`);
                input.disabled = false;
                return;
            }
            
            // Validate row has correct ID
            if (String(row.dataset.id) !== idStr) {
                console.error(`[ask] Row ID mismatch: expected ${idStr}, got ${row.dataset.id}`);
                input.disabled = false;
                return;
            }
            
            // Store row reference to protect against DOM changes during async operations
            const rowRef = {
                element: row,
                id: idStr,
                question: question
            };
            
            console.log(`[ask] Found row for id ${idStr}, updating status and answer display`);
            
            // Update status
            const statusCell = getCellByColumnId(row, 'status');
            if (statusCell) {
                statusCell.innerHTML = '<span class="badge badge-processing">Processing...</span>';
                console.log(`[ask] Status updated to Processing`);
            } else {
                console.warn(`[ask] Could not find status cell for id ${id}`);
            }
            
            // Update answer display
            const answerCell = getCellByColumnId(row, 'answer');
            if (!answerCell) {
                console.error(`[ask] Could not find answer cell for id ${idStr}`);
            } else {
                let answerDisplay = answerCell.querySelector(`#answerDisplay${idStr}`) || 
                                   answerCell.querySelector('.answer-display') ||
                                   document.getElementById(`answerDisplay${idStr}`);
                
                if (!answerDisplay) {
                    // Create the answer display structure if it doesn't exist
                    console.log(`[ask] Creating answerDisplay structure for id ${idStr}`);
                    answerCell.innerHTML = `
                        <div class="answer-display" id="answerDisplay${idStr}">
                            <div class="answer-text" style="color: #9ca3af;">🤔 AI is thinking...</div>
                            <button class="edit-answer-btn" onclick="editAnswer('${idStr}')" title="Edit answer manually">✏️</button>
                        </div>
                        <div class="answer-edit" id="answerEdit${idStr}" style="display: none;">
                            <textarea class="answer-editable" id="answerText${idStr}" placeholder="Enter manual answer..."></textarea>
                            <div>
                                <button class="save-answer-btn" onclick="saveAnswer('${idStr}')">Save</button>
                                <button class="cancel-answer-btn" onclick="cancelEditAnswer('${idStr}')">Cancel</button>
                            </div>
                        </div>
                    `;
                    answerDisplay = answerCell.querySelector(`#answerDisplay${idStr}`);
                    console.log(`[ask] Created answerDisplay for id ${idStr}`);
                } else {
                    answerDisplay.innerHTML = `
                        <div class="answer-text" style="color: #9ca3af;">🤔 AI is thinking...</div>
                        <button class="edit-answer-btn" onclick="editAnswer('${idStr}')" title="Edit answer manually">✏️</button>
                    `;
                    console.log(`[ask] Updated existing answerDisplay for id ${idStr} to "AI is thinking..."`);
                }
            }
            
            input.disabled = true;
            
            try {
                console.log(`[ask] Sending question to API: "${question}", project_id: ${currentProjectId}`);
                const r = await fetch(`${API}/api/ask`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question,
                        project_id: currentProjectId
                    })
                });
                
                // Check if response is OK before parsing
                if (!r.ok) {
                    const errorData = await r.json().catch(() => ({ detail: `HTTP ${r.status}: ${r.statusText}` }));
                    throw new Error(errorData.detail || `Server error: ${r.status}`);
                }
                
                const data = await r.json();
                console.log('[ask] Received response:', data);
                
                // Re-find and validate the row after async operation
                let currentRow = document.querySelector(`[data-id="${idStr}"]`) || document.querySelector(`[data-id='${idStr}']`);
                
                // Verify row still exists and matches our stored reference
                if (!currentRow) {
                    console.error(`[ask] Could not find row for id ${idStr} after async operation`);
                    input.disabled = false;
                    return;
                }
                
                // Validate row ID still matches and question still matches
                if (String(currentRow.dataset.id) !== idStr) {
                    console.error(`[ask] Row ID changed after async: expected ${idStr}, got ${currentRow.dataset.id}`);
                    input.disabled = false;
                    return;
                }
                
                // Verify this is the correct row by checking the question input
                const questionInput = currentRow.querySelector(`#q${idStr}`);
                if (!questionInput || questionInput.value.trim() !== rowRef.question) {
                    console.error(`[ask] Row question mismatch - answer may belong to different question`);
                    // Try to find row by stored reference if it still exists
                    if (rowRef.element && rowRef.element.parentNode && String(rowRef.element.dataset.id) === idStr) {
                        currentRow = rowRef.element;
                        console.log(`[ask] Using stored row reference instead`);
                    } else {
                        input.disabled = false;
                        return;
                    }
                }
                
                // Get the answer cell first, then find the answerDisplay within it
                const answerCell = getCellByColumnId(currentRow, 'answer');
                let answerDisplay = null;
                
                if (answerCell) {
                    // First try to find by ID within the cell
                    answerDisplay = answerCell.querySelector(`#answerDisplay${idStr}`);
                    // Fallback: find by class
                    if (!answerDisplay) {
                        answerDisplay = answerCell.querySelector('.answer-display');
                    }
                    // Last resort: try document.getElementById
                    if (!answerDisplay) {
                        answerDisplay = document.getElementById(`answerDisplay${idStr}`);
                    }
                }
                
                if (answerDisplay) {
                    console.log(`[ask] Found answerDisplay for id ${idStr}, updating with answer:`, data.answer ? data.answer.substring(0, 50) + '...' : 'empty');
                    const answerText = data.answer && data.answer.trim() ? data.answer : 'No answer received';
                    const answerColor = data.answer && data.answer.trim() ? '' : 'color: #ef4444;';
                    
                    // Escape HTML in answer text for safety
                    const safeAnswerText = answerText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    // Update synchronously first
                    answerDisplay.innerHTML = `
                        <div class="answer-text" style="${answerColor}">${safeAnswerText}</div>
                        <button class="edit-answer-btn" onclick="editAnswer('${idStr}')" title="Edit answer manually">✏️</button>
                    `;
                    
                    // Force browser to repaint and make sure it's visible
                    answerDisplay.style.visibility = 'visible';
                    answerDisplay.style.display = '';
                    void answerDisplay.offsetHeight;
                    
                    // Also update again in next frame to ensure visibility
                    requestAnimationFrame(() => {
                        if (answerDisplay && answerDisplay.parentElement) {
                            answerDisplay.style.visibility = 'visible';
                            void answerDisplay.offsetHeight;
                        }
                    });
                } else {
                    console.error(`[ask] Could not find answerDisplay element for id ${id} in answer cell`);
                    // If we can't find it, try to create it or update the cell directly
                    if (answerCell) {
                        console.log(`[ask] Answer cell found, creating answerDisplay element directly`);
                        const answerText = data.answer && data.answer.trim() ? data.answer : 'No answer received';
                        const answerColor = data.answer && data.answer.trim() ? '' : 'color: #ef4444;';
                        
                        // Update synchronously
                        answerCell.innerHTML = `
                            <div class="answer-display" id="answerDisplay${id}">
                                <div class="answer-text" style="${answerColor}">${answerText}</div>
                                <button class="edit-answer-btn" onclick="editAnswer(${id})" title="Edit answer manually">✏️</button>
                            </div>
                            <div class="answer-edit" id="answerEdit${id}" style="display: none;">
                                <textarea class="answer-editable" id="answerText${id}" placeholder="Enter manual answer..."></textarea>
                                <div>
                                    <button class="save-answer-btn" onclick="saveAnswer(${id})">Save</button>
                                    <button class="cancel-answer-btn" onclick="cancelEditAnswer(${id})">Cancel</button>
                                </div>
                            </div>
                        `;
                        
                        // Make sure the cell is visible
                        answerCell.style.visibility = 'visible';
                        answerCell.style.display = '';
                        void answerCell.offsetHeight;
                        
                        // Ensure it stays visible in next frame
                        requestAnimationFrame(() => {
                            if (answerCell && answerCell.parentElement) {
                                answerCell.style.visibility = 'visible';
                                void answerCell.offsetHeight;
                            }
                        });
                    } else {
                        console.error(`[ask] Could not find answer cell for id ${idStr}. Visible columns:`, columns.filter(c => c.visible).map(c => c.id));
                    }
                }
                
                if (data.sources && data.sources.length > 0) {
                    const uniqueSources = [];
                    const seen = new Set();
                    for (const s of data.sources) {
                        if (!seen.has(s.filename)) {
                            seen.add(s.filename);
                            uniqueSources.push(s);
                        }
                    }
                    
                    const sourceHtml = uniqueSources.map(s => 
                        `<a href="#" onclick="openSource('${s.filename}'); return false;" class="source-link" title="Click to open document">
                            📄 ${s.filename}
                        </a>`
                    ).join('');
                    const sourceCell = getCellByColumnId(currentRow, 'source');
                    if (sourceCell) {
                        sourceCell.innerHTML = `<div class="source-list">${sourceHtml}</div>`;
                    }
                } else {
                    const sourceCell = getCellByColumnId(currentRow, 'source');
                    if (sourceCell) {
                        sourceCell.innerHTML = '<span class="empty-text">No sources</span>';
                    }
                }
                
                const statusCell = getCellByColumnId(currentRow, 'status');
                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge badge-done">Done</span>';
                }
                const dateCell = getCellByColumnId(currentRow, 'date');
                if (dateCell) {
                    dateCell.innerHTML = `<span style="font-size: 0.813rem; color: #6b7280;">${new Date().toLocaleDateString()}</span>`;
                }
                
                // Get qa_id from response if available
                const qaId = data.qa_id || null;
                if (qaId && currentRow) {
                    currentRow.dataset.qaId = qaId;
                }
                
                let q = qs.find(x => String(x.id) === idStr);
                if (q) {
                    q.question = question;
                    q.answer = data.answer;
                    q.sources = data.sources || [];
                    q.qa_id = qaId;
                    if (!q.followups) {
                        q.followups = [];
                    }
                } else {
                    // Question not in qs, add it now
                    q = {
                        id: idStr,
                        question: question,
                        answer: data.answer,
                        sources: data.sources || [],
                        qa_id: qaId,
                        followups: []
                    };
                    qs.push(q);
                }
                
                input.disabled = false;
                updateThread(idStr);
                updateStats();
                loadProjects(); // Reload project list to refresh question count
                
                // Only add new row if answer completed successfully and this wasn't a followup
                if (!q || !q.parentId) {
                    // Small delay to ensure DOM updates are complete
                    setTimeout(() => {
                        addQ();
                    }, 100);
                }
            } catch (e) {
                console.error('[ask] Error:', e);
                // Re-find and validate the row after error
                let currentRow = document.querySelector(`[data-id="${idStr}"]`) || document.querySelector(`[data-id='${idStr}']`);
                if (!currentRow) {
                    // Try stored reference if available
                    if (rowRef && rowRef.element && rowRef.element.parentNode && String(rowRef.element.dataset.id) === idStr) {
                        currentRow = rowRef.element;
                    } else {
                        input.disabled = false;
                        return;
                    }
                }
                
                // Validate row ID
                if (String(currentRow.dataset.id) !== idStr) {
                    console.error(`[ask] Row ID mismatch in error handler: expected ${idStr}, got ${currentRow.dataset.id}`);
                    input.disabled = false;
                    return;
                }
                
                // Get the answer cell first, then find the answerDisplay within it
                const answerCell = getCellByColumnId(currentRow, 'answer');
                let answerDisplay = null;
                
                if (answerCell) {
                    answerDisplay = answerCell.querySelector(`#answerDisplay${idStr}`) || 
                                   answerCell.querySelector('.answer-display') ||
                                   document.getElementById(`answerDisplay${idStr}`);
                }
                
                if (answerDisplay) {
                    const safeErrorMessage = String(e.message || 'Unknown error').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    answerDisplay.innerHTML = `
                        <div class="answer-text" style="color: #ef4444;">⚠️ Error: ${safeErrorMessage}</div>
                        <button class="edit-answer-btn" onclick="editAnswer('${idStr}')" title="Edit answer manually">✏️</button>
                    `;
                    void answerDisplay.offsetHeight; // Force repaint
                } else if (answerCell) {
                    // Fallback: update cell directly
                    answerCell.innerHTML = `
                        <div class="answer-display" id="answerDisplay${id}">
                            <div class="answer-text" style="color: #ef4444;">⚠️ Error: ${e.message}</div>
                            <button class="edit-answer-btn" onclick="editAnswer(${id})" title="Edit answer manually">✏️</button>
                        </div>
                        <div class="answer-edit" id="answerEdit${id}" style="display: none;">
                            <textarea class="answer-editable" id="answerText${id}" placeholder="Enter manual answer..."></textarea>
                            <div>
                                <button class="save-answer-btn" onclick="saveAnswer(${id})">Save</button>
                                <button class="cancel-answer-btn" onclick="cancelEditAnswer(${id})">Cancel</button>
                            </div>
                        </div>
                    `;
                }
                
                const statusCell = getCellByColumnId(currentRow, 'status');
                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge badge-error">Error</span>';
                }
                input.disabled = false;
            }
        }
        
        function updateThread(id) {
            const q = qs.find(x => x.id == id);
            if (!q) return;  // Question not found
            if (!q.followups) {
                q.followups = [];  // Initialize if missing
            }
            if (q.followups.length == 0) {
                const el = document.getElementById('thread' + id);
                if (el) el.innerHTML = '';  // Clear thread button if no followups
                return;
            }
            
            const el = document.getElementById('thread' + id);
            if (!el) return;
            
            const rows = document.querySelectorAll(`[data-parent="${id}"]`);
            const collapsed = rows[0] && rows[0].classList.contains('hidden');
            
            el.innerHTML = `<button class="btn-toggle" onclick="toggle(${id})">${collapsed ? '▶' : '▼'} ${q.followups.length} follow-up${q.followups.length > 1 ? 's' : ''}</button>`;
        }
        
        function toggle(id) {
            document.querySelectorAll(`[data-parent="${id}"]`).forEach(r => r.classList.toggle('hidden'));
            updateThread(id);
        }
        
        // Upload
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        
        uploadBox.onclick = () => fileInput.click();
        
        fileInput.onchange = async (e) => {
            // Debug: Check currentProjectId
            console.log('Upload attempt - currentProjectId:', currentProjectId, 'currentView:', currentView);
            
            if (!currentProjectId) {
                alert('Please select or create a project first');
                return;
            }
            
            for (let file of e.target.files) {
                const fd = new FormData();
                fd.append('file', file);
                try {
                    console.log('Uploading file:', file.name, 'to project:', currentProjectId);
                    const r = await fetch(`${API}/api/upload?project_id=${currentProjectId}`, {
                        method: 'POST', 
                        body: fd
                    });
                    const responseData = await r.json();
                    console.log('Upload response:', responseData);
                    if (r.ok && responseData.success) {
                        alert('✓ ' + file.name + ' uploaded!');
                    } else {
                        alert('Failed to upload ' + file.name + ': ' + (responseData.detail || responseData.message || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('Upload error:', e);
                    alert('Error uploading ' + file.name + ': ' + e.message);
                }
            }
            loadDocs();
            loadProjectDocuments(currentProjectId);
            loadProjects(); // Reload project list to refresh counts
        };
        
        async function loadDocs() {
            try {
                // Only load documents if a project is selected
                if (!currentProjectId) {
                    const list = document.getElementById('docList');
                    if (list) {
                        list.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 30px;">Please select a project to view documents.</p>';
                    }
                    return;
                }
                
                const url = `${API}/api/documents?project_id=${currentProjectId}`;
                const r = await fetch(url);
                const data = await r.json();
                const list = document.getElementById('docList');
                
                if (data.documents && data.documents.length > 0) {
                    list.innerHTML = data.documents.map(d => `
                        <div class="doc-card">
                            <div class="doc-name">
                                <span>📄</span>
                                <span>${d.filename}</span>
                            </div>
                            <div class="doc-meta">
                                <div>📊 Pages: <strong>${d.pages || 'N/A'}</strong></div>
                                <div>📅 Uploaded: <strong>${new Date(d.upload_date).toLocaleDateString()}</strong></div>
                                <div>💾 Size: <strong>${formatSize(d.size)}</strong></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 30px;">No documents uploaded yet. Upload your first document above!</p>';
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        async function loadQAHistory() {
            try {
                if (!currentProjectId) {
                    console.log('[loadQAHistory] No currentProjectId, skipping');
                    return;
                }
                
                console.log('[loadQAHistory] Loading Q&A for project:', currentProjectId);
                const r = await fetch(`${API}/api/qa?project_id=${currentProjectId}`);
                const data = await r.json();
                
                // Clear existing Q&A and add saved ones
                qs = [];
                const tbody = document.getElementById('tbody');
                if (!tbody) {
                    console.error('[loadQAHistory] tbody element not found!');
                    return;
                }
                tbody.innerHTML = '';
                
                if (data.success && data.qa_list && data.qa_list.length > 0) {
                    // Add all Q&A entries from the server
                    for (let i = 0; i < data.qa_list.length; i++) {
                        const qa = data.qa_list[i];
                        // Generate unique ID, ensuring it's a valid number for legacy compatibility
                        const id = qs.length > 0 ? Math.max(...qs.map(q => parseInt(q.id) || 0)) + 1 : Date.now();
                        const row = tbody.insertRow(-1);
                        row.dataset.id = id;
                        // Store Q&A ID for deletion
                        if (qa.id) {
                            row.dataset.qaId = qa.id;
                        }
                        
                        // Assign row number (use stored row_number if available, otherwise use index + 1)
                        const rowNumber = (qa.row_number || (i + 1)).toString();
                        row.dataset.rowNumber = rowNumber;
                        
                        // Add row number cell first
                        const rowNumTd = document.createElement('td');
                        rowNumTd.className = 'row-number-cell';
                        rowNumTd.innerHTML = `
                            <span>${rowNumber}</span>
                            <button class="row-delete-btn" onclick="event.stopPropagation(); deleteRow(${id})" title="Delete row">×</button>
                        `;
                        rowNumTd.dataset.rowNumber = rowNumber;
                        rowNumTd.title = `Row ${rowNumber}`;
                        row.appendChild(rowNumTd);
                        
                        // Build row with visible columns
                        columns.filter(col => col.visible).forEach(col => {
                            const td = document.createElement('td');
                            
                            if (col.id === 'question') {
                                const safeQuestion = (qa.question || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                td.innerHTML = `
                                    <input class="q" id="q${id}" 
                                           data-row-id="${id}"
                                           value="${safeQuestion}"
                                           placeholder="Type and press Enter"
                                           onkeypress="if(event.key=='Enter' || event.keyCode===13) { const rowId = this.getAttribute('data-row-id') || this.id.replace('q',''); ask(rowId); }">
                                    <button class="btn-followup" onclick="addQ('${id}')">↪</button>
                                    <span id="thread${id}"></span>
                                `;
                            } else if (col.id === 'answer') {
                                td.innerHTML = `
                                    <div class="answer-display" id="answerDisplay${id}">
                                        <div class="answer-text">${qa.answer}</div>
                                        <button class="edit-answer-btn" onclick="editAnswer(${id})" title="Edit answer manually">✏️</button>
                                    </div>
                                `;
                            } else if (col.id === 'source') {
                                if (qa.sources && qa.sources.length > 0) {
                                    const sourceHtml = qa.sources.map(s => 
                                        `<div class="source-item">📄 ${s.filename}</div>`
                                    ).join('');
                                    td.innerHTML = `<div class="source-list">${sourceHtml}</div>`;
                                } else {
                                    td.innerHTML = '<span class="empty-text">No sources</span>';
                                }
                            } else if (col.id === 'status') {
                                td.innerHTML = '<span class="badge badge-done">Done</span>';
                            } else if (col.id === 'date') {
                                td.style.fontSize = '0.813rem';
                                td.style.color = '#6b7280';
                                const date = qa.created_at ? new Date(qa.created_at).toLocaleDateString() : new Date().toLocaleDateString();
                                td.innerHTML = `<span>${date}</span>`;
                            }
                            
                            row.appendChild(td);
                        });
                        
                        qs.push({
                            id,
                            question: qa.question,
                            answer: qa.answer,
                            sources: qa.sources || [],
                            followups: []
                        });
                    }
                }
                
                // Always add a new question row after loading Q&A history
                addQ();
                
                updateStats();
            } catch (e) {
                console.error('Failed to load Q&A history:', e);
                // Even if loading fails, add a new question row
                addQ();
            }
        }
        
        function formatSize(bytes) {
            if (!bytes) return 'N/A';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function updateStats() {
            // Don't update the count here - use updateProjectStats() instead
            // The count should come from the backend API, not the frontend array
            // This function is kept for compatibility but does nothing
        }
        
        function exportExcel() {
            const answered = qs.filter(q => q.question && q.answer);
            
            if (answered.length === 0) {
                alert('No questions answered yet. Ask some questions first!');
                return;
            }
            
            const questions = answered.map(q => q.question).join('|||');
            const answers = answered.map(q => q.answer).join('|||');
            
            window.location.href = `${API}/api/export?questions=${encodeURIComponent(questions)}&answers=${encodeURIComponent(answers)}`;
        }
        
        async function openSource(filename) {
            try {
                const r = await fetch(`${API}/api/documents`);
                const data = await r.json();
                
                if (data.documents) {
                    const doc = data.documents.find(d => d.filename === filename);
                    if (doc) {
                        const viewUrl = `${API}/api/view/${doc.id}`;
                        window.open(viewUrl, '_blank');
                    } else {
                        alert('Document not found: ' + filename);
                    }
                }
            } catch (e) {
                console.error('Error opening source:', e);
                alert('Failed to open document');
            }
        }
        
        function editAnswer(id) {
            const displayDiv = document.getElementById(`answerDisplay${id}`);
            const editDiv = document.getElementById(`answerEdit${id}`);
            const textarea = document.getElementById(`answerText${id}`);
            
            const q = qs.find(x => x.id == id);
            // Show formula if it exists, otherwise show computed value
            const currentText = q && q.formula ? q.formula : (displayDiv.querySelector('.answer-text') ? displayDiv.querySelector('.answer-text').textContent : '');
            
            textarea.value = currentText;
            displayDiv.style.display = 'none';
            editDiv.style.display = 'block';
            textarea.focus();
        }
        
        function saveAnswer(id) {
            const displayDiv = document.getElementById(`answerDisplay${id}`);
            const editDiv = document.getElementById(`answerEdit${id}`);
            const textarea = document.getElementById(`answerText${id}`);
            const newAnswer = textarea.value.trim();
            
            if (newAnswer) {
                // Check if it's a formula
                const isFormula = newAnswer.startsWith('=');
                let displayValue = newAnswer;
                
                if (isFormula) {
                    const result = parseFormula(newAnswer);
                    displayValue = result.isFormula ? result.value : newAnswer;
                }
                
                displayDiv.innerHTML = `
                    <div class="answer-text">${displayValue}</div>
                    <button class="edit-answer-btn" onclick="editAnswer(${id})" title="Edit answer manually">✏️</button>
                `;
                
                const q = qs.find(x => x.id == id);
                if (q) {
                    if (isFormula) {
                        q.formula = newAnswer;
                        q.answer = displayValue;
                    } else {
                        q.answer = newAnswer;
                        q.formula = null;
                    }
                    q.manual = true;
                }
                
                editDiv.style.display = 'none';
                displayDiv.style.display = 'block';
                
                // Recalculate all formulas if this was a formula
                if (isFormula) {
                    recalculateAllFormulas();
                }
                
                updateStats();
            } else {
                alert('Please enter an answer');
            }
        }
        
        function cancelEditAnswer(id) {
            const displayDiv = document.getElementById(`answerDisplay${id}`);
            const editDiv = document.getElementById(`answerEdit${id}`);
            editDiv.style.display = 'none';
            displayDiv.style.display = 'block';
        }
        
        // Delete row functionality
        async function deleteRow(rowId) {
            const row = document.querySelector(`[data-id="${rowId}"]`);
            if (!row) {
                console.error(`[deleteRow] Could not find row with id ${rowId}`);
                return;
            }
            
            if (!confirm('Are you sure you want to delete this row? This action cannot be undone.')) {
                return;
            }
            
            // Get Q&A ID from the row data
            const qaId = row.dataset.qaId || null;
            
            // Remove from DOM first
            row.remove();
            
            // Remove from qs array
            qs = qs.filter(q => q.id != rowId);
            
            // Renumber remaining rows
            renumberRows();
            
            // Delete from backend if qaId exists
            if (qaId && currentProjectId) {
                try {
                    const r = await fetch(`${API}/api/qa/${qaId}?project_id=${currentProjectId}`, {
                        method: 'DELETE'
                    });
                    if (!r.ok) {
                        console.error(`[deleteRow] Failed to delete Q&A from backend: ${r.status}`);
                    }
                } catch (e) {
                    console.error(`[deleteRow] Error deleting Q&A from backend:`, e);
                }
            }
            
            updateStats();
        }
        
        // Delete column functionality
        function deleteColumn(columnId) {
            const col = columns.find(c => c.id === columnId);
            if (!col) {
                console.error(`[deleteColumn] Column ${columnId} not found`);
                return;
            }
            
            // Don't allow deleting default columns (question, answer)
            if (col.id === 'question' || col.id === 'answer') {
                alert('Cannot delete required columns (Question and Answer)');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete column "${col.name}"? This action cannot be undone.`)) {
                return;
            }
            
            // Remove column from array
            columns = columns.filter(c => c.id !== columnId);
            
            // Reassign column letters
            assignColumnLetters();
            
            // Re-render table
            renderTableHeader();
            renderTable();
            renderColumnOptions();
            
            // Recalculate formulas as column references may have changed
            recalculateAllFormulas();
        }
        
        // Close modal when clicking outside
        document.getElementById('newProjectModal').onclick = (e) => {
            if (e.target.id === 'newProjectModal') {
                closeNewProjectModal();
            }
        };
        
        // Init
        window.onload = async () => {
            console.log('Loaded');
            initializeColumns();
            await loadProjects();
            // Show landing page by default
            showLandingPage();
            addQ();
            // Note: loadDocs() and loadQAHistory() are called in selectProject(), not here
            // This ensures documents are only loaded when a project is explicitly selected
        };
    </script>
</body>
</html>
